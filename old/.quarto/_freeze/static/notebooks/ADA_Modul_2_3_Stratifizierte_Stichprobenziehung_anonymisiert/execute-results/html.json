{
  "hash": "74b822f56ab7e0f017572c1ca7620541",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"ADA Bayern\"\nsubtitle: \"Modul 2: Stratfizierte Stichprobe\"\nformat:\n  html:\n    toc: true\n    number-sections: true\n    highlight-style: github\n    embed-resources: true\n    df-print: paged\neditor: visual\nexecute:\n  eval: false\n---\n\n\n\n## Ziel des Notebooks\n\nIn diesem Notebook lernen wir eine stratifizierte oder auch geschichtete Zufallsstichprobe zu ziehen. Das Ziel ist es dieses Wissen für das Projekt zu nutzen. Wir wollen interessante Spalten für die Stratifizierung identifizieren und den Code in diesem Notebook für das Projekt anpassen.\n\n**Zur Anonymisierung wurde dieses File nachträglich verändert!**\n\n## Software-Pakete laden\n\nWir laden erneut die gleichen Pakete, die wir auch schon zum Ziehen der einfachen Zufallstichprobe benötigt haben.\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(\"tidyverse\")\nlibrary(\"survey\")\nlibrary(\"PracTools\")\nlibrary(\"sf\")\n```\n:::\n\n\n\n## Einlesen der Daten\n\nIn diesem Schritt lesen wir die Daten in R ein. Der Code ist genau wie zuvor.\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\npfad <- file.path(\".\")\ncol_types <- c(\"ccccnccccccccccccccccccTTcnTccnTcTcccc\")\n\nforumstar_daten <- read_csv(file.path(pfad, \"230817_Abfrage_Januar-Dezember.csv\"), col_types = col_types)\nkarte_amtsgerichte <- readRDS(file.path(pfad, \"230911_Karte_Amtsgerichtsbezirke.RDS\"))\n```\n:::\n\n\n\n## Daten für die Stichprobenziehung vorbereiten\n\nFür die Stichprobenziehung benötigen wir nicht alle Spalten des Datensatzes. Daher bereiten wir die Daten zunächst vor. Für eine einfache Stichprobenziehung reicht ein Eintrag pro Akte aus. Die beteiligten Personen interessieren uns hier zunächst nicht. Mit dem folgenden Code aggregieren wir die Daten auf einen Eintrag pro Aktenzeichen[^1].\n\n[^1]: Dazu verwenden wir die `group_by` Funktion. Zusätzlich erstellen wir mithilfe der Funktion `summarise()`eine neue Spalte `Anzahl Beteiligte`. Anschließend fügen wir noch eine eindeutige Index Spalte `Index` für jede Akte hinzu.\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nakten <- forumstar_daten %>%\n  group_by(\n    `Gericht`,\n    `Aktenzeichen`,\n    `Streitwert in EURO`,\n    `Gesamtstreitgegenstand`,\n    `Erledigungsgrund`,\n    `Dauer des Verfahrens in Tagen`,\n    `Archivstatus`,\n    `Anbietungsgrund (manuell erfasst)`,\n    `Anbietungsgrund`\n  ) %>%\n  summarise(`Anzahl Beteiligte` = n()) %>%\n  as.data.frame() %>%\n  mutate(Index = row_number())\n```\n:::\n\n\n\nUm unsere visuelle Darstellung auf Karten zu ermöglichen generieren wir außerdem die Spalte Bezirk und fügen sie unserem Datensatz hinzu.\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ntmp_Gericht <- sub(\"Amtsgericht \", \"\", akten$Gericht)\ntmp_Gericht <- sub(\" Zweigstelle.*\", \"\", tmp_Gericht)\ntmp_Gericht <- sub(\" i.d. \", \" i. d. \", tmp_Gericht)\ntmp_Gericht <- sub(\" a.d. \", \" a. d. \", tmp_Gericht)\ntmp_Gericht <- sub(\" am \", \" a. \", tmp_Gericht)\ntmp_Gericht <- sub(\" i.OB\", \" i. OB\", tmp_Gericht)\n\nakten <- akten %>%\n  mutate(`Bezirk` = tmp_Gericht)\n```\n:::\n\n\n\n## Ziehung einer stratifizierten Zufallsstichprobe, stratifiziert nach Amtsgerichtsbezirken\n\nBei einer stratifizierten Stichprobe werden zusätzlich verfügbare Information aus der Grundgesamtheit zur Stichprobenziehung verwendet.\n\nVielleicht wollen wir sicherstellen, dass Akten aus allen Amtsgerichtsbezirken archiviert werden? Dann könnten Historiker in Zukunft verschiedenen Regionen Bayerns untereinander vergleichen. Mit diesem Gedanken sollen nun zufällig zehn Akten pro Bezirk gezogen werden.\n\nVon jedem Amtsgerichtsbezirk (jeder Bezirk bildet hier ein sogenanntes Stratum) benötigen wir die Gesamtzahl der zur Verfügung stehenden Akten.\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nbeschreibung_stichprobe <- akten %>% \n  group_by(`Bezirk`) %>%\n  summarise(`Anzahl Akten` = n()) %>%\n  arrange(`Bezirk`)\n```\n:::\n\n\n\nNun sollen aus jedem Bezirk zehn Akten zufällig ausgewählt werden.\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nbeschreibung_stichprobe <- beschreibung_stichprobe %>% \n  mutate(`Stichprobengröße` = 10)\n```\n:::\n\n\n\nZur Vorbereitung der Stichprobenziehung werden die Infos aus `beschreibung_stichprobe` an die Grundgesamtheit herangespielt.\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nakten_fuer_stratifizierung_nach_gericht <- akten %>%\n  left_join(beschreibung_stichprobe, by = \"Bezirk\")\n```\n:::\n\n\n\nNun erfolgt die Stichprobenziehung[^2].\n\n[^2]: Mit `set.seed` wird zunächst ein Seed gesetzt, so dass immer dieselbe Stichprobe gezogen wird.\n\n    Bezirk soll unsere Stratumsvariable sein. Daher werden mittels `group_by` die nachfolgenden Schritte für jedes Gericht einzeln getrennt voneinander durchgeführt.\n\n    Alle Akten eines jeden Gerichts werden durchnummeriert von 1 bis zur Gesamtzahl der Akten vom jeweiligen Gericht `n()`, die Nummern werden anschließend mittels `sample` gemischt und jede Akte bekommt in der Variablen `samp` eine Nummer zugewiesen. Akten mit einer Nummer kleiner oder gleich 10 (vorgegeben in der Variablen `anzahl_akten_pro_gericht`) werden herausge`filter`t und bleiben in der Stichprobe erhalten.\n\n    Abschließend wird die Hilfsvariable `samp` gelöscht, indem ihr der Wert `NULL` zugewiesen wird.\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nset.seed(20230919)\nstratifizierte_stichprobe_nach_gericht <- akten_fuer_stratifizierung_nach_gericht %>%\n  group_by(Bezirk) %>%\n  mutate(samp = sample(n())) %>%\n  filter(samp <= `Stichprobengröße`) %>%\n  ungroup()\n\nstratifizierte_stichprobe_nach_gericht$samp <- NULL\n```\n:::\n\n\n\nAlle nötigen Infos zur Beschreibung der Stichprobe sind in der folgenden Tabelle vorhanden:\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nbeschreibung_stichprobe\n```\n:::\n\n\n\nKurze Prüfung. Haben wir tatsächlich zehn Akten pro Gericht gezogen?\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nstratifizierte_stichprobe_nach_gericht %>%\n  group_by(`Bezirk`) %>%\n  summarise(n())\n```\n:::\n\n\n\n**Wie viele Akten liegen insgesamt in der Stichprobe vor?**\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nnrow(stratifizierte_stichprobe_nach_gericht)\n```\n:::\n\n\n\n### Ist die stratifizierte Stichprobe repräsentativ?\n\nAkten aus kleinen Amtsgerichtsbezirken hatten in dieser Stichprobe eine deutlich höhere Wahrscheinlichkeit, in die Stichprobe zu gelangen, als zum Beispiel aus dem Amtsgericht München. Wenn man dies unberücksichtigt lässt, können keine statistisch validen Aussagen über die Grundgesamtheit getroffen werden.\n\nFür repräsentative statistische Aussagen müssen Gewichte verwendet werden. Akten mit geringer Auswahlwahrscheinlichkeit stehen für eine größere Anzahl von Akten und erhalten damit ein größeres Gewicht.\n\nDie Auswahlwahrscheinlichkeit berechnet sich in jedem Stratum getrennt als\n\n-   Auswahlwahrscheinlichkeit = Anzahl (Stichprobe) / Anzahl (Grundgesamtheit)\n\nDas Gewicht (= Hochrechnungsfaktor) ergibt sich als\n\n-   Hochrechnungsfaktor = 1 / Auswahlwahrscheinlichkeit\n\nEine Akte mit einem Hochrechnungsfaktor von z.B. 20 wurde also mit einer Wahrscheinlichkeit von 5% in die Stichprobe gezogen und steht nun repräsentativ für 20 Akten, die alternativ hätten gezogen werden können.\n\nAuswahlwahrscheinlichkeit und Hochrechnungsfaktor lassen sich allein aus den Angaben zur Beschreibung der Stichprobe wie folgt berechnen.\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nstratifizierte_stichprobe_nach_gericht <- stratifizierte_stichprobe_nach_gericht %>%\n  mutate(Auswahlwahrscheinlichkeit = `Stichprobengröße` / `Anzahl Akten`) %>%\n  mutate(Hochrechnungsfaktor = 1 / Auswahlwahrscheinlichkeit)\n```\n:::\n\n\n\nHier zeigt sich also, warum diese Dokumentation der Stichprobe so wichtig ist.\n\nAls Beispiel soll nun die mittlere Anzahl der Prozessbeteiligten geschätzt werden.\n\nIn der Grundgesamtheit können wir dies berechnen als\n\n$$\n\\bar{y} = \\frac{\\sum_{grundgesamtheit} 1 \\cdot y_i}{N}\n$$\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmean(akten$`Anzahl Beteiligte`)\n```\n:::\n\n\n\nAnhand der Stichprobe können wir mittels folgender Formel ungefähr den selben Wert erhalten\n\n$$\n\\hat{\\bar{y}}=\\frac{\\sum_{stichprobe} hrf_i \\cdot y_i}{\\sum_{stichprobe} hrf_i}\n$$\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsum(stratifizierte_stichprobe_nach_gericht$Hochrechnungsfaktor * stratifizierte_stichprobe_nach_gericht$`Anzahl Beteiligte`) / sum(stratifizierte_stichprobe_nach_gericht$Hochrechnungsfaktor)\n```\n:::\n\n\n\nZum selben Ergebnis führt auch der folgende Code[^3].\n\n[^3]: Die Funktionen `svydesign`, `svymean` und `confint` kommen aus dem `survey`-package. Mit `svydesign` lässt sich das Design der Stichprobe beschreiben. Die anderen Funktionen nutzen dieses Design zur Berechnung vom gewichteten Mittelwert bzw. zur Berechnung des Konfidenzintervalls.\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmy_stratified_design <- svydesign(id = ~0, strata = ~Bezirk, data = stratifizierte_stichprobe_nach_gericht, fpc = ~Auswahlwahrscheinlichkeit)\n\nsvymean(~`Anzahl Beteiligte`, my_stratified_design, na.rm = TRUE)\n```\n:::\n\n\n\nZusätzlich lässt sich noch das Konfidenzintervall berechnen, welches mit 95%-Wahrscheinlichkeit den wahren Wert aus der Grundgesamtheit überdeckt. Damit kann die Genauigkeit der Schätzung beurteilt werden.\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nconfint(svymean(~`Anzahl Beteiligte`, my_stratified_design, na.rm = TRUE))\n```\n:::\n\n\n\nEine naive Schätzung der mittleren Anzahl Prozessbeteiligter berechnet einfach nur den Mittelwert der Stichprobe und lässt dabei die unterschiedlichen Auswahlwahrscheinlichkeiten außer Acht.\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmean(stratifizierte_stichprobe_nach_gericht$`Anzahl Beteiligte`)\n```\n:::\n\n\n\nAnders als die Schätzung oben ist dieser Wert nicht zur Beschreibung der Grundgesamtheit geeignet. Nur wenn Gewichte (=Hochrechnungsfaktoren) verwendet werden, können aus der Stichprobe Ergebnisse abgeleitet werden, die repräsentativ für die Grundgesamtheit sind.\n\n## Ziehung einer stratifizierten Stichprobe, stratifiziert nach Verfahrensdauer\n\nEine stratifizierte Stichprobe kann noch aus einem anderen Grund sinnvoll sein: In diesem Beispiel sollen Akten mit einer langen Verfahrensdauer besonders häufig archiviert werden, da diese Akten besonders umfangreich und informativ sein könnten.\n\nZunächst betrachten wir einen kurze Zusammenfassung der Verfahrensdauer.\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsummary(akten$`Dauer des Verfahrens in Tagen`)\n```\n:::\n\n\n\nDie stetige Variable `Dauer des Verfahrens in Tagen` diskretisieren wir:\n\n-   kurzes Verfahren, wenn die Verfahrensdauer weniger als 100 Tage betrug\n\n-   mittleres Verfahren bei 100-1500 Tagen\n\n-   langes Verfahren ab 1500 Tagen Verfahrensdauer\n\nBei fehlenden Werten wird von einem kurzen Verfahren ausgegangen.\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nakten <- akten %>% mutate(\n    verfahrensdauer = case_when(\n      `Dauer des Verfahrens in Tagen` < 100 ~ \"kurzes Verfahren\",\n      `Dauer des Verfahrens in Tagen` >= 100 & `Dauer des Verfahrens in Tagen` < 1500 ~ \"mittleres Verfahren\",\n      `Dauer des Verfahrens in Tagen` >= 1500 ~ \"langes Verfahren\",\n      is.na(`Dauer des Verfahrens in Tagen`) ~ \"kurzes Verfahren\",\n      TRUE ~ as.character(`Dauer des Verfahrens in Tagen`)\n    )\n)\n```\n:::\n\n\n\nDie Variable `verfahrensdauer` dient zur Stratifizierung. Zur Beschreibung der Stichprobe wird zunächst gezählt, wie viele Akten eine kurze/mittlere/lange Verfahrensdauer haben.\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nbeschreibung_stichprobe <- akten %>% \n  group_by(verfahrensdauer) %>%\n  summarise(akten_pro_stratum = n()) %>%\n  arrange(verfahrensdauer)\n\nbeschreibung_stichprobe\n```\n:::\n\n\n\nWir setzen die Stichprobengröße für jedes einzelne Stratum händisch. Dabei sollen alle 178 langen Verfahren archiviert werden.\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nbeschreibung_stichprobe <- beschreibung_stichprobe %>% mutate(\n     anzahl_akten_pro_schicht = case_when(\n      verfahrensdauer == \"kurzes Verfahren\" ~ 50,\n      verfahrensdauer == \"mittleres Verfahren\" ~ 100,\n      verfahrensdauer == \"langes Verfahren\" ~ 178)\n)\n\nbeschreibung_stichprobe\n```\n:::\n\n\n\nMit dem bereits oben beschriebenen Code kann hier wieder die Stichprobe gezogen werden.\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nakten_fuer_stratifizierung_nach_verfahrensdauer <- akten %>%\n  left_join(beschreibung_stichprobe, by = \"verfahrensdauer\")\n\nset.seed(46)\nstratifizierte_stichprobe_nach_verfahrensdauer <- akten_fuer_stratifizierung_nach_verfahrensdauer %>%\n  group_by(verfahrensdauer) %>%\n  mutate(samp = sample(n())) %>%\n  filter(samp <= anzahl_akten_pro_schicht) %>%\n  ungroup()\n\nstratifizierte_stichprobe_nach_gericht$samp <- NULL\n```\n:::\n\n\n\nEin kurzer Check, ob die Stichprobenziehung erfolgreich war.\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ntable(stratifizierte_stichprobe_nach_verfahrensdauer$verfahrensdauer)\n```\n:::\n\n\n\n### Wie kann die Stichprobengröße pro Schicht bestimmt werden? (optional)\n\nHier wurde händisch vorgegeben, wie viele Akten aus jeder Schicht archiviert werden sollen. Alternativ wäre auch möglich:\n\n-   Proportionale Allokation: Proportional zum Umfang der jeweiligen Schicht, stellt Repräsentativität bezüglich des Schichtungsmerkmals sicher\n-   Equal (gleiche) Allokation: gleiches $n$ in jedem Stratum, so wie es oben bei der Stratifizierung nach Gerichten erfolgt ist\n-   Optimale Allokation: Optimiere die Genauigkeit der Schätzung für eine Variable. Die Varianz dieser Variablen muss dafür bekannt sein.\n\nDie Stichprobengröße pro Schicht soll nun mit jeder der drei genannten Methoden bestimmt werden. Als Schichtungsvariable verwenden wir erneut die `verfahrensdauer` (kurz/mittel/lang). Anhand der Grundgesamtheit berechnen wir, wie viele Akten $N_h$ in jeder Schicht $h$ vorhanden sind. Für die optimale Allokation benötigen wir zusätzlich noch die Varianz derjenigen Variablen, für die eine möglichst genaue Schätzung erzielt werden soll.\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nbeschreibung_stichprobe_allokation <- akten %>% \n  group_by(verfahrensdauer) %>%\n  summarise(akten_pro_stratum = n(),\n            variance_pro_stratum = var(`Dauer des Verfahrens in Tagen`, na.rm = TRUE)) %>%\n  arrange(verfahrensdauer)\n```\n:::\n\n\n\nZusätzlich geben wir an, dass die Stichprobe insgesamt $n = 200$ Akten enthalten soll. Mithilfe der folgenden Formeln lässt sich nun berechnen, wie viele Akten aus jeder Schicht $h$ gezogen werden:\n\n$$n_{h, proportional} = Runden(n \\cdot \\frac{N_h}{N}) = Runden(n \\cdot \\frac{N_h}{\\sum_{h' = 1}^M N_{h'}})$$\n\n$$n_{h, optimal} = Runden(n \\cdot \\frac{N_h \\cdot S_h}{\\sum_{h' = 1}^M N_{h'} \\cdot S_{h'}})$$\n\n$$n_{h, equal} = Runden(n/M)$$\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nN <- nrow(akten)\nn <- 200\n\ndenom <- sum(beschreibung_stichprobe_allokation$akten_pro_stratum * beschreibung_stichprobe_allokation$variance_pro_stratum)\n\nbeschreibung_stichprobe_allokation <- beschreibung_stichprobe_allokation %>%\n  mutate(proportional_allocation = round((n / N) * akten_pro_stratum),\n         optimal_allocation = round(n * akten_pro_stratum * variance_pro_stratum / denom),\n         equal_allocation = round(n / nrow(beschreibung_stichprobe_allokation)))\n\nbeschreibung_stichprobe_allokation\n```\n:::\n\n\n\nDa es nur sehr wenige lange Verfahren gibt, gelangt kein einziges davon bei einer Zuordnung proportional zur Anzahl (`proportional allocation`) in die Stichprobe.\n\nBei der `optimal allocation` wird versucht, möglichst viel über die `Dauer des Verfahrens in Tagen` (oder ein damit korrelierendes Merkmal) zu erfahren. Bei den kurzen Verfahren wissen wir bereits, dass alle Verfahren weniger als 50 Tage dauern (kleine Varianz). Entsprechend gering ist der Informationsgewinn, wenn ein solches Verfahren in die Stichprobe gelangt. Umgekehrt kann die Länge eines langen Verfahrens (\\>1500 Tage) stark streuen. Um dennoch möglichst akkurat die mittlere Dauer der langen Verfahren berechnen zu können, müssten hier sehr viele Akten gezogen werden.\n\nBei der `equal allocation` gelangt jede Schicht gleich häufig in die Stichprobe.\n\n## Diskussion: Was muss berücksichtigt werden? Was sind Vor- und Nachteile einer stratifizierten Stichprobe?\n\n-   Ist die stratifizierte Stichprobe zur Auswahl von Akten geeignet? Welche Vor- und Nachteile hat das Verfahren?\n\n-   Anhand welcher Variablen definiert man einzelne Strata? Welche Schwellwerte verwendet man bei kontinuierlichen Variablen?\n\n-   Wie viele Akten werden aus jedem Stratum gezogen? (Proportionale Allokation, Equal Allokation, Optimal Allokation, oder noch was anderes?)\n\n**Vorteile**:\n\n-   Unterschiedliche Auswahlwahrscheinlichkeiten in jedem Stratum\n\n-   Konfidenzintervalle werden schmaler wenn Selektionswahrscheinlichkeiten und Zielvariable korreliert sind.\n\n-   Garantierte Mindestzahl an Fällen in jedem Stratum (zum Beispiel zehn Akten pro Gericht)\n\n-   Jedes Stratum einer stratifizierten Zufallsstichprobe lässt sich auch einzeln auswerten (einfach wie eine einfache Zufallsstichprobe, jedoch ist die Grundgesamtheit nun beschränkt auf das Stratum).\n\n-   Einfach verständlich und gut dokumentierbar\n\n**Nachteile:**\n\n-   Unterschiedliche Auswahlwahrscheinlichkeiten in jedem Stratum\n\n-   Kein Effizienzgewinn (unter Umstand. sogar -verlust), wenn Selektionswahrscheinlichkeiten und Zielvariablen nicht (bzw. negativ) korreliert sind\n\n-   Mehr Dokumentationsaufwand\n\n## Diskussion: Wie wollen wir als Gruppe Akten für die Archivierung auswählen?\n\n-   Einfache Zufallsstichprobe vs. stratifiziert?\n\n-   Wenn stratifiziert, wie wählen wir die Strata aus?\n\n-   Oder gar keine Zufallsstichprobe (zum Beispiel zehn Akten je Gericht mit den meisten Beteiligten?)\n\n-   Wie viele Akten wählen wir?\n\n-   Welche Informationen zum Auswahlprozess müssen wir dokumentieren und kommunizieren?",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {
      "include-in-header": [
        "<link href=\"../../site_libs/pagedtable-1.1/css/pagedtable.css\" rel=\"stylesheet\" />\n<script src=\"../../site_libs/pagedtable-1.1/js/pagedtable.js\"></script>\n"
      ]
    },
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}